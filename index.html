<!-- ========= Playlist Calculator Logic (improved errors) ========= -->
<script>
const DEFAULT_PLAYLIST_ID = 'PLRBY4cYxp2r_2mCaMtEF8U6QdQX4gCqvL';

/*
  IMPORTANT:
  Keep your real key here for now (testing). When you get a custom domain,
  restrict this key to your domain in Google Cloud.
*/
const apiKey = 'AIzaSyD5R9Z-wq1GU0KFpMwZIxPda4ho5wawgq0'; // your key

document.getElementById('calcBtn').addEventListener('click', runCalc);

async function runCalc(){
  const playlistRaw = (document.getElementById('playlistInput').value || '').trim();
  const msg = document.getElementById('calcMsg');
  const resultsBox = document.getElementById('results');
  msg.textContent = '';
  resultsBox.style.display = 'none';

  if(!apiKey){
    msg.textContent = 'No API key found in the script (apiKey variable).';
    return;
  }

  const playlistId = extractPlaylistId(playlistRaw) || DEFAULT_PLAYLIST_ID;
  msg.textContent = 'Calculating… (fetching playlist items)';

  try{
    const videoIds = await getAllPlaylistVideoIds(playlistId, apiKey);
    if(videoIds.length === 0){
      msg.textContent = 'No videos found in this playlist.';
      return;
    }

    msg.textContent = `Found ${videoIds.length} videos. Fetching durations…`;
    const durations = await getVideoDurations(videoIds, apiKey);
    const totalSeconds = durations.reduce((a,b)=>a+b,0);
    const avgSeconds = Math.round(totalSeconds / durations.length);

    document.getElementById('totalDuration').textContent = formatHMS(totalSeconds);
    document.getElementById('videoCount').textContent = String(durations.length);
    document.getElementById('avgLength').textContent = formatHMS(avgSeconds);
    resultsBox.style.display = 'grid';
    msg.textContent = 'Done.';
  }catch(err){
    console.error(err);
    msg.textContent = 'Error: ' + err.message;
  }
}

function extractPlaylistId(input){
  if(!input) return null;
  try{
    if(input.startsWith('http')){
      const u = new URL(input);
      const list = u.searchParams.get('list');
      if(list) return list;
      const maybe = u.pathname.split('/').find(p => p && p.startsWith('PL'));
      return maybe || null;
    } else {
      return /^([A-Za-z0-9_-]){10,}$/.test(input) ? input : null;
    }
  }catch{ return null; }
}

async function getAllPlaylistVideoIds(playlistId, key){
  const ids = [];
  let pageToken = '';

  do{
    const url = new URL('https://www.googleapis.com/youtube/v3/playlistItems');
    url.searchParams.set('part','contentDetails');
    url.searchParams.set('playlistId', playlistId);
    url.searchParams.set('maxResults','50');
    url.searchParams.set('key', key);
    if(pageToken) url.searchParams.set('pageToken', pageToken);

    const data = await fetchJSON(url);
    (data.items || []).forEach(it => {
      const vid = it?.contentDetails?.videoId;
      if(vid) ids.push(vid);
    });
    pageToken = data.nextPageToken || '';
  } while(pageToken);

  return ids;
}

async function getVideoDurations(videoIds, key){
  const batches = [];
  for(let i=0;i<videoIds.length;i+=50) batches.push(videoIds.slice(i,i+50));

  const secondsArr = [];
  for(const batch of batches){
    const url = new URL('https://www.googleapis.com/youtube/v3/videos');
    url.searchParams.set('part','contentDetails');
    url.searchParams.set('id', batch.join(','));
    url.searchParams.set('key', key);

    const data = await fetchJSON(url);
    (data.items || []).forEach(v => {
      const iso = v?.contentDetails?.duration || 'PT0S';
      secondsArr.push(isoToSeconds(iso));
    });
  }
  return secondsArr;
}

async function fetchJSON(url){
  const res = await fetch(url.toString());
  let payload = null;

  try { payload = await res.json(); } catch { /* ignore */ }

  if(!res.ok){
    // Surface the real YouTube error message if available
    const apiMsg = payload?.error?.message;
    const reason = payload?.error?.errors?.[0]?.reason;
    const composed = apiMsg ? `${apiMsg}${reason ? ' ('+reason+')' : ''}` : `HTTP ${res.status}`;
    throw new Error(composed);
  }
  return payload || {};
}

function isoToSeconds(iso){
  const m = (iso||'').match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
  if(!m) return 0;
  const h = parseInt(m[1]||'0',10);
  const min = parseInt(m[2]||'0',10);
  const s = parseInt(m[3]||'0',10);
  return h*3600 + min*60 + s;
}

function formatHMS(total){
  const h = Math.floor(total/3600);
  const m = Math.floor((total%3600)/60);
  const s = total%60;
  const parts = [];
  if(h) parts.push(h+' hr');
  if(m || !h) parts.push(m+' min');
  parts.push(s+' sec');
  return parts.join(' ');
}
</script>
